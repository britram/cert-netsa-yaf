<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
"http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<title>YAF - Documentation</title>
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
        <link rel="stylesheet" type="text/css" href="doxygen.css">
        <link rel="stylesheet" type="text/css" href="../../site/style.css" />
        <link rel="stylesheet" type="text/css" href="tabs.css">
</head>
<body>
    <div id="p-body">
      <div id="l-header">
        <img src="../../site/sei-logo.png" id="l-sei-logo"
            alt="Software Engineering Institute | Carnegie Mellon&copy;" />
        <div id="l-netsa-logo"><a id="l-netsa-name" href="../../index.html"><b>CERT NetSA Security Suite</b></a></div>
        <div id="l-netsa-motto">Monitoring for Large-Scale Networks</div>
        <h1 class="l-page-title">YAF</h1>
        <span id="l-subtitle">Documentation</span>
      </div><!-- l-header -->
      <div id="l-content">
        <div id="l-sidebar">
          <div class="p-sidebar-section">
            <h1><a href="index.html">YAF</a></h1>
            <ul>
              <li><a href="../docs.html">Documentation</a></li>
              <li><a href="../download.html">Downloads</a></li>
            </ul>
          </div><!-- p-sidebar-section -->
        </div><!-- l-sidebar -->
      <div id="top"> <!-- need this for doxygen -->
<!-- Generated by Doxygen 1.8.11 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Tutorials</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">YAF PCAP Export Features </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>This tutorial will explain how <b>yaf</b> can create rolling PCAP files and indexes to quickly find a flow within the PCAP repository. The <a href="yaf_pcap.html">previous tutorial</a> described how to use <b>yaf</b> to index PCAP files and create PCAPs using flow information.</p>
<ul>
<li><a href="#overview">Overview</a></li>
<li><a href="#setup">Setup</a></li>
<li><a href="#first">First Approach</a></li>
<li><a href="#second">Second Approach</a></li>
</ul>
<h1><a class="anchor" id="overview"></a>
Overview </h1>
<p>In many environments the capturing of PCAP and flow are decoupled and the analysis that occurs with flow data often requires further examination with PCAP. In many cases, analysts have developed custom scripts to search PCAP files for a particular flow. This can be difficult when a flow spans multiple PCAP files and it is hard to determine which PCAP files they should be analyzing.</p>
<p><b>yaf</b> can capture and write rolling PCAP files as well as generate the flow data and provide an index (using flow characteristics) into the PCAP data for quick and easy retrieval of a particular stream.</p>
<p>There are two approaches for indexing the PCAP files that <b>yaf</b> is creating. Both will be discussed here. Using the first approach, <b>yaf</b> will write one line to the pcap-meta-file for each FLOW that is contained in a PCAP file. For example, if a flow spans three PCAP files, the pcap-meta-file will contain 3 rows for the flow. The second approach configures <b>yaf</b> to write one line in the pcap-meta-file for each PCAP. This requires more storage up front, but provides very quick retrieval of the PCAP.</p>
<p>This example will configure <b>yaf</b> to export to a rwflowpack (SiLK) instance that will create a local repository of flow data. This tutorial does not provide details on installing and configuring SiLK, see <a href="yaf_silk.html">this page</a> for more details.</p>
<h1><a class="anchor" id="setup"></a>
SETUP        </h1>
<p>Create a file directory to store the PCAP data: </p><pre class="fragment">$ mkdir /data/pcap
</pre><p>Create a directory for the flow repository and logging: </p><pre class="fragment">$ mkdir /data/flow
$ mkdir /var/log/rwflowpack
</pre><p>Create a sensor configuration file for rwflowpack (<a href="http://tools.netsa.cert.org/silk/sensor.conf.html">sensor.conf</a>): </p><pre class="fragment">probe S0 ipfix
      protocol tcp
      listen-on-port 18001
end probe

sensor S0
       ipfix-probes S0
       internal-ipblock 192.168.1.0/24
       external-ipblock remainder
end sensor
</pre><p>Additionally, you will need to create a SiLK site configuration file (<a href="http://tools.netsa.cert.org/silk/silk.conf.html">silk.conf</a>). For this example, the one located in the SiLK tarball in <code>site/twoway/silk.conf</code> should suffice.</p>
<p>Start rwflowpack: </p><pre class="fragment">/usr/local/sbin/rwflowpack --sensor-conf=/data/flow/sensor.conf \
                   --root-dir=/data/flow \
                   --log-directory=/var/log/rwflowpack \
                   --site-config=/data/flow/silk.conf \
                   --pack-interfaces
</pre><p>Confirm rwflowpack is running and is listening on port 18001: </p><pre class="fragment">$ netstat -an | grep 18001
tcp4       0      0  *.18001                *.*                    LISTEN
</pre><h1><a class="anchor" id="first"></a>
First Approach         </h1>
<p>This first approach will demonstrate how to use the rolling PCAP option in <b>yaf</b> with the pcap-meta-file option to write one line to the given file for each <b>FLOW</b> that is contained in a PCAP File. For example, if a flow spans three PCAP files, the pcap-meta-file will contain 3 rows for the flow. The <b>yafMeta2Pcap</b> tool will be used to query the pcap-meta-files for a particular flow and provide the file names of the PCAP files that contain the flow. <b>yaf</b> will then be run again over the particular PCAP files that contain the flow, and <b>yafMeta2Pcap</b> will create the PCAP file for the flow. For a slightly quicker process, jump to the <a href="#second">second approach</a>.</p>
<p>Start <b>yaf</b>: </p><pre class="fragment">yaf --in eth0 --live pcap \
    --out localhost \
    --ipfix tcp --ipfix-port 18001 \
    --applabel --max-payload=500 \
    --silk \
    --pcap /data/pcap/yaf_pcap \
    --pcap-meta-file /data/yaf_pcap_meta --pcap-timer=60 \
--max-pcap=500 \
    -d --log=/var/log/yaf.log --pidfile=/var/log/yaf.pid
</pre><p>By using the above options, <b>yaf</b> will create rolling PCAP files that will rotate every 60 seconds (or 500MB) and write index information to the pcap-meta-file. The default maximum file size for PCAP files is 25 MB. By default, <b>yaf</b> will rotate PCAP files every 5 minutes or when the file reaches 25 MB. Both the size and time are used to determine when a PCAP file should be rotated. If you prefer to only rotate on time, set *&ndash;max-pcap* to something very large. If you prefer to only rotate when a file reaches a particular size, set *&ndash;pcap-timer* to a high value. <b>yaf</b> will "lock" the files until the time has expired or the file limit is reached, meaning that <b>yaf</b> will add ".lock" to the end of the filename until it has finished writing to it. The pcap-meta-file will rotate before the file reaches 2 GB.</p>
<p>For this example, we will do a few SiLK queries to pick a flow we want to view the PCAP for. <a href="http://tools.netsa.cert.org/silk/rwfilter.html">rwfilter</a> is the most import analysis tool included with the SiLK tools. <b>rwfilter</b> is an application for querying the data repository for flow records that satisfy a set of filtering options. The SiLK tools are intended to be combined to perform a particular task. The analysis performed below will also use <a href="http://tools.netsa.cert.org/silk/rwstats.html">rwstats</a>, <a href="http://tools.netsa.cert.org/silk/rwcut.html">rwcut</a>, and <a href="http://tools.netsa.cert.org/silk/rwsilk2ipfix.html">rwsilk2ipfix</a>. <b>rwstats</b> is used to summarize and sort SiLK flow records. <b>rwcut</b> is used to print the attributes of SiLK flow records in a delimited, columnar, human-readable format. <b>rwsilk2ipfix</b> convers a stream of SiLK flow records to IPFIX format.</p>
<p>To use the SiLK command line tools, set the <b>SILK_DATA_ROOTDIR</b> environment variable to your flow repository: </p><pre class="fragment">$ export SILK_DATA_ROOTDIR=/data/flow

$ rwstats --fields=29 --top --count=20
INPUT: 395 Records for 5 Bins and 395 Total Records
OUTPUT: Top 20 Bins by Records
appli|   Records|  %Records|   cumul_%|
    0|       160| 40.506329| 40.506329|
  443|       124| 31.392405| 71.898734|
   80|        77| 19.493671| 91.392405|
   53|        30|  7.594937| 98.987342|
  137|         4|  1.012658|100.000000|
</pre><p>The above query shows what application protocols are running on my network. Let's choose one of the unknown protocols (label 0): </p><pre class="fragment">$ rwfilter --pass-destination=stdout \
           --application=0 --type=all \
       --max-pass-records=2 \
       | rwcut --fields=1,2,3,4,5,6,7,9,13,14
            sIP|            dIP|sPort|dPort|pro|   packets|     bytes|\
                      sTime|   in|  out|
    10.20.11.51|    10.64.22.15|61416| 8080|  6|         3|       156|\
    2014/01/29T15:02:39.025|    0|    0|
    10.64.22.15|    10.20.11.51| 8080|61416|  6|         2|       104|\
    2014/01/29T15:02:39.026|    0|    0|
</pre><p>Now we have all the information we need to find the PCAP for this flow. The following command will query the data for one particular flow and <b>rwsilk2ipfix</b> will convert the SiLK flow record to IPFIX. <b>getFlowKeyHash</b> takes IPFIX as input, by default, and prints the 5-tuple, vlan, flow key hash, and start time in milliseconds to stdout. </p><pre class="fragment">$ rwfilter --pass-destination=stdout \
           --application=0 --type=all \
       --max-pass-records=1 \
       | rwsilk2ipfix | getFlowKeyHash
            sIP|            dIP|sPort|dPort|pro| vlan|      hash|                  ms
    10.20.11.51|    10.64.22.15|61416| 8080|  6|    0|4022100716|       1391007759025

FILE PATH: 025/4022100716-201412915239_0.pcap
</pre><p>Instead of performing the previous command and piping the output of <b>rwfilter</b> to <b>rwsilk2ipfix</b> to <b>getFlowKeyHash</b>, we can manually type the information on the command line to <b>getFlowKeyHash</b>: </p><pre class="fragment">$ getFlowKeyHash -s 10.20.11.51 \
             -d 10.64.22.15 \
         -S 61416 -D 8080 -p 6 \
             -y 2014-01-29 -t 15:02:39.025
            sIP|            dIP|sPort|dPort|pro| vlan|      hash|                  ms
    10.20.11.51|    10.64.22.15|61416| 8080|  6|    0|4022100716|       1391007759025

FILE PATH: 025/4022100716-201412915239_0.pcap
</pre><p>Now we can provide the information to <b>yafMeta2Pcap</b>. You can see that we provided a glob pattern of the pcap-meta-files that <b>yaf</b> produced. Alternatively, you could provide a text file that contains a list of the names of the pcap-meta-files (see the <a href="#second">second approach</a> for an example). If an output file is not provided to <b>yafMeta2Pcap</b>, the tool simply returns the name of the PCAP file that contains the flow we are interested in. If our flow had been a long flow, and spanned multiple PCAP files, the output of <b>yafMeta2Pcap</b> would have been all of the file names that contain the flow. </p><pre class="fragment">$ yafMeta2Pcap -f "/tmp/yaf_pcap_meta*" \
           -h 4022100716 \
           -t 1391007759025
/data/pcap/yaf_pcap20140129150236_00000.pcap
</pre><p>If we provide an output file, <b>yafMeta2Pcap</b> will create the PCAP file for the flow by running a <b>yaf</b> process that will only create the PCAP file for the flow using the hash and start time. The following examples provides an example of combining all the tools to generate a single PCAP file. </p><pre class="fragment">$ rwfilter --pass-destination=stdout \
           --application=0 --type=all \
           --max-pass-records=1 \
           | rwsilk2ipfix | getFlowKeyHash -I |
       yafMeta2Pcap -f "/tmp/yaf_pcap_meta*" \
       -o /tmp/mypcap.pcap    

Found 5 packets that match criteria.

$ capinfos -c /tmp/mypcap.pcap
File name:           /tmp/mypcap.pcap
Number of packets:   5
</pre><p>The second example assumes that <b>yaf</b> was installed in your $PATH. If <b>yaf</b> was installed in a non-standard place, you can use the *&ndash;yaf-program* option to specify the correct location of <b>yaf</b>.</p>
<h1><a class="anchor" id="second"></a>
Second Approach </h1>
<p>The alternate method is to run <b>yaf</b> with the <code>--index-pcap</code> option to write one line for each packet into the pcap-meta-file. The <b>rwfilter</b> and <b>getFlowKeyHash</b> steps are the same as above. Alternatively, you could pipe the output of <b>rwfilter</b> to <b>rwsilk2ipfix</b> to <b>getFlowKeyHash</b>. </p><pre class="fragment">$ yaf --in en2 --live pcap \
      --out localhost --ipfix tcp --ipfix-port 18001 \
      --applabel --max-payload=500 --silk \
      --pcap /tmp/pcap/yaf_pcap \
      --pcap-meta-file /tmp/yaf_pcap_meta \
      --pcap-timer=60 --index-pcap \
      -d --log=/var/log/yaf.log --pidfile=/var/log/yaf.pid

$ rwfilter --pass-destination=stdout \
       --application=0 \
       --start-date=2014/01/29:16 \
       --type=all --max-pass-records=2 \
       | rwcut --fields=1,2,3,4,5,6,7,9,13,14
            sIP|            dIP|sPort|dPort|pro|   packets|     bytes|\
                      sTime|   in|  out|
    10.20.11.51|    10.64.22.15|62024| 8080|  6|         2|        92|\
    2014/01/29T16:32:44.301|    0|    0|
    10.64.22.15|    10.20.11.51| 8080|62024|  6|         2|       104|\
    2014/01/29T16:32:44.301|    0|    0|

$ getFlowKeyHash -s 10.20.11.51 -d 10.64.22.15 \
             -o 62024 -r 8080 -p 6 \
         -y 2014-01-29 -t 16:32:44.301
            sIP|            dIP|sPort|dPort|pro| vlan|      hash|                  ms
    10.20.11.51|    10.64.22.15|62024| 8080|  6|    0|4061946604|       1391013164301

FILE PATH: 301/4061946604-2014129163244_0.pcap
</pre><p>Now we can use the <b>yafMeta2Pcap</b> and the pcap-meta-files to get the PCAP we are looking for. Unlike the first example, where a glob pattern is provided to *&ndash;pcap-meta-file*, this example creates a list of all the meta files. </p><pre class="fragment">$ ls -d -rt -1 /tmp/yaf_pcap_meta* &gt; /tmp/meta-list.txt

$ yafMeta2Pcap -m /tmp/meta-list.txt -t 1391013164301 \
           -h 4061946604 -o /tmp/mypcap.pcap -y
Found 4 packets that match criteria.

$ capinfos -c /tmp/mypcap.pcap
File name:           /tmp/mypcap.pcap
Number of packets:   4
</pre><p>This tutorial has shown two different ways of using <b>yaf</b> to capture full PCAP and index it via flow data. The second approach has a few less steps but stores a line in the pcap-meta-file for each packet as opposed to the first approach that writes a line for each flow, filename unique pair. The second approach creates larger pcap-meta-files and requires more frequent writes to the pcap-meta-files. </p>
</div></div><!-- contents -->
      </div><!-- l-content -->
      <div id="l-footer">&copy; 2006-2016 Carnegie Mellon University</div>
    </div><!-- p-body -->
</body>
</html>   
