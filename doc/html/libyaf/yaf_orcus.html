<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
"http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<title>YAF - Documentation</title>
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
        <link rel="stylesheet" type="text/css" href="doxygen.css">
        <link rel="stylesheet" type="text/css" href="../../site/style.css" />
        <link rel="stylesheet" type="text/css" href="tabs.css">
</head>
<body>
    <div id="p-body">
      <div id="l-header">
        <img src="../../site/sei-logo.png" id="l-sei-logo"
            alt="Software Engineering Institute | Carnegie Mellon&copy;" />
        <div id="l-netsa-logo"><a id="l-netsa-name" href="../../index.html"><b>CERT NetSA Security Suite</b></a></div>
        <div id="l-netsa-motto">Monitoring for Large-Scale Networks</div>
        <h1 class="l-page-title">YAF</h1>
        <span id="l-subtitle">Documentation</span>
      </div><!-- l-header -->
      <div id="l-content">
        <div id="l-sidebar">
          <div class="p-sidebar-section">
            <h1><a href="index.html">YAF</a></h1>
            <ul>
              <li><a href="../docs.html">Documentation</a></li>
              <li><a href="../download.html">Downloads</a></li>
            </ul>
          </div><!-- p-sidebar-section -->
        </div><!-- l-sidebar -->
      <div id="top"> <!-- need this for doxygen -->
<!-- Generated by Doxygen 1.8.11 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Tutorials</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">YAF with Orcus </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>This tutorial describes how to configure <b>yaf</b> and <b>Orcus</b> to create a passive DNS database using PostgreSQL. It is possible to use Oracle as the database. For information on using Oracle with Orcus, see these <a href="http://tools.netsa.cert.org/orcus/doc/install.html#database-configuration-and-schema-installation">instructions</a>. This tutorial will also describe how to use <b>super_mediator</b> for deduplication of DNS records and forking IPFIX streams to <a href="http://tools.netsa.cert.org/silk/index.html">SiLK</a> and <a href="http://tools.netsa.cert.org/orcus/index.html">Orcus</a>.</p>
<ul>
<li><a href="#database">Database Configuration</a></li>
<li><a href="#orcus">Orcus Configuration</a></li>
<li><a href="#yaf">Install and Configure YAF</a></li>
<li><a href="#view">Sample Orcus Queries</a></li>
<li><a href="#sm">Using super_mediator</a></li>
</ul>
<h1><a class="anchor" id="database"></a>
Database Configuration </h1>
<p>First step is to install PostgreSQL. The PostgreSQL wiki provides adequate <a href="http://www.postgresql.org/docs/9.3/static/installation.html">instructions</a> for installing from source code. You could also use one of the following: </p><pre class="fragment">$ apt-get install postgresql
$ yum install postgresql93-server
</pre><p>Initialize a database storage area on disk. PostgreSQL must have permissions to write to the database storage area. It is recommended to <a href="http://www.postgresql.org/docs/current/static/postgres-user.html">create a PostgreSQL user account</a>. Some operating systems (e.g. Ubuntu) create a postgres user when PostgreSQL is installed. Login as the postgres user and run the following. You may need to add the location of initdb to your PATH. <em>Note that on some operating systems the database is already initialized and the server is started automatically after install. The following steps may not be required if this is the case.</em> </p><pre class="fragment">$ mkdir /usr/local/pgsql/data
$ mkdir /var/log/postgres
$ chown postgres /usr/local/pgsql/data
$ chown postgres /var/log/postgres
$ sudo su - postgres
$ export PATH=/usr/lib/postgresql/9.1/bin:$PATH
$ initdb -D /usr/local/pgsql/data
</pre><p>Start the PostgreSQL server: </p><pre class="fragment">$ pg_ctl start -D /usr/local/pgsql/data -l /var/log/postgres/postgres.log
</pre><p>Create the Orcus database: </p><pre class="fragment">$ createdb orcus
</pre><p>Create roles for Orcus: </p><pre class="fragment">$ psql orcus
orcus=&gt; create user orcus login password 'orcus';
orcus=&gt; create user orcususer login password 'orcus';
</pre><p>Change the owner of the orcus database to orcus: </p><pre class="fragment">orcus=&gt; alter database orcus owner to orcus;
</pre><h1><a class="anchor" id="orcus"></a>
Install and Configure Orcus: </h1>
<p>Besides glib2, glib2-devel, libpcap, libpcap-devel, python, python-devel, libpcre, and libpcre-devel, you will also need the following:</p>
<p>Libfixbuf 1.3.0 or greater is required. Install libfixbuf before installing Orcus: </p><pre class="fragment">$ tar -xvzf libfixbuf-1.7.0.tar.gz
$ cd libfixbuf-1.7.0
$ ./configure
$ make 
$ make install
</pre><p>psycopg2 2.4.5+ is required. </p><pre class="fragment">$ tar -xvzf psycopg2-2.5.2.tar.gz
$ cd psycopg2-2.5.2
$ python setup.py build
$ python setup.py install
</pre><p>Install netsa-python. </p><pre class="fragment">$ tar -xvzf netsa-python-1.4.3.tar.gz
$ cd netsa-python-1.4.3
$ python setup.py build
$ python setup.py install
</pre><p>Install Orcus. PKG_CONFIG_PATH should be set to the location of libfixbuf.pc: </p><pre class="fragment">$ tar -xvzf orcus-1.0.3.tar.gz
$ cd orcus-1.0.3
$ export PKG_CONFIG_PATH=/usr/local/lib/pkgconfig
$ python setup.py build
$ python setup.py install
</pre><p>Install (as postgres user) the Orcus schema (provided in the Orcus tarball in sql/): </p><pre class="fragment">$ psql -U orcus -d orcus -q -f sql/create-sa_orcus-1.0.0-postgres.sql
 create_rr_tables
 ------------------
</pre><p>If you see an error similar to: </p><pre class="fragment">psql: FATAL:  Peer authentication failed for user "orcus"
</pre><p>You may need to modify the pg_hba.conf file: (/etc/postgresql/9.1/main/pg_hba.conf). Change the following line from: </p><pre class="fragment">local    all          postgres       peer
</pre><p>to: </p><pre class="fragment">local    all          postgres       md5
</pre><p>Restart the postgresql server after making this change.</p>
<p>Create the Orcus configuration file (copy sample provided in tarball): </p><pre class="fragment">$ cp orcus.conf.sample /etc/orcus.conf
</pre><p>The orcus.conf file contains settings for the <a href="http://tools.netsa.cert.org/orcus/doc/man-orloader.html#man-orloader">orloader</a>, <a href="http://tools.netsa.cert.org/orcus/doc/man-orlookup.html">orlookup</a>, and <a href="http://tools.netsa.cert.org/orcus/doc/man-orquery.html">orquery</a>. Many of the configuration settings are simply file directories that <b>orloader</b> uses for polling, processing, and logging. By default, <b>orloader</b> uses several directories in <code>/data/orcus</code>. For this tutorial, we will use the defaults. We will need to create the following directories: </p><pre class="fragment">$ mkdir /data/orcus
$ mkdir /data/orcus/incoming
$ mkdir /data/orcus/loading
$ mkdir /data/orcus/error
$ mkdir /data/orcus/archive
</pre><p>We will need to edit the following line with our password for the Orcus database: </p><pre class="fragment">database-uri: nsql-postgres:orcus;user=orcus;password=orcus
</pre><p>Additionally, if we want <b>orloader</b> to interpret IP addresses appropriately, we need to specify our internal network: </p><pre class="fragment">net-list: 192.168.0.0/16, fe80::/64
</pre><p>Start <b>orloader</b>: </p><pre class="fragment">$ orloader --config-file /etc/orcus.conf &amp;
</pre><h1><a class="anchor" id="yaf"></a>
Install and Configure YAF </h1>
<p>Install yaf: </p><pre class="fragment">$ tar -xvzf yaf-2.6.0.tar.gz
$ cd yaf-2.6.0
$ ./configure --enable-applabel --enable-plugins
$ make
$ make install
$ cp etc/yaf.conf /usr/local/etc/yaf.conf
$ cp etc/init.d/yaf /etc/init.d/yaf
$ chmod +x /etc/init.d/yaf
</pre><p>If you plan to run <b>yaf</b> as a service, Edit yaf.conf to configure rolling IPFIX output for <b>orloader</b>. The "filter" part in the <b>YAF_EXTRAFLAGS</b> is optional as it will limit <b>yaf</b> to only processing data on port 53. You should not use a BPF filter if you plan to export all flow data to SiLK. </p><pre class="fragment">ENABLED=1
YAF_CAP_TYPE=pcap
YAF_CAP_IF=eth0
YAF_IPFIX_PROTO=
YAF_IPFIX_HOST=
YAF_IPFIX_PORT=
YAF_ROTATE_LOCATION=/data/yaf/yafdns
YAF_ROTATE_TIME=60
YAF_STATEDIR=
YAF_PIDFILE=
YAF_LOG=
YAF_USER=
YAF_EXTRAFLAGS="--applabel --max-payload=2048 \
--plugin-name=/usr/local/lib/yaf/dpacketplugin.la --plugin-opts=53 \
--udp-uniflow=53 --filter='port 53'"
</pre><p>Start yaf as a service: </p><pre class="fragment">$ start yaf start
</pre><p>Or on the command line: </p><pre class="fragment">$ yaf --in eth0 --live pcap --out /data/yaf/yafdns \
      --rotate 60 --lock --applabel --max-payload=2048 \
  --plugin-name=/usr/local/lib/yaf/dpacketplugin.la \
  --udp-uniflow=53 --plugin-opts=53 --filter="port 53"\
  --log=/var/log/yaf.log --pidfile=/var/run/yaf.pid -d 
</pre><p>If you see an error similar to: </p><pre class="fragment">Starting yaf:    /usr/local/bin/yaf: error while loading shared libraries: libairframe-2.6.0.so.4: cannot open shared object file: No such file or directory
[Failed]
</pre><p>Run: </p><pre class="fragment">$ ldconfig
</pre><p><b>yaf</b> should <em>NOT</em> be configured to write IPFIX files to the same directory that <b>orloader</b> is polling. <b>orloader</b> does not understand <b>yaf's</b> locking process and will steal files from <b>yaf</b> while they are still being written to. <a href="http://tools.netsa.cert.org/yaf/filedaemon.html">filedaemon</a> can be used to move files from one directory to another. </p><pre class="fragment">$ mkdir /data/yaf/fail
$ filedaemon --in '/data/yaf/yafdns*'\
         --nextdir=/data/orcus/incoming \
         --lock 
</pre><h1><a class="anchor" id="view"></a>
Sample Queries </h1>
<p>Below are some example queries to view the data:</p>
<p>View A records between 01-01-2010 and 09-09-2010: </p><pre class="fragment">$ orquery --config-file=/etc/orcus.conf \
          --start-date=2010/01/01 \
      --end-date=2010/09/09 \
      --fields=sensor,address,type,time,direction,rr-name,rr-a\
      --type=A
</pre><p>View NXDOMAIN Queries for today: </p><pre class="fragment"> $ oquery --config-file=/etc/orcus.conf \
          --fields=sensor,address,type,time,direction,q-name \
      --type=NXDOMAIN
</pre><p>Use <b>orlookup</b> to find records related to yahoo: </p><pre class="fragment">$ orlookup --config-file=/etc/orcus.conf \
           --start-date=2010/01/01 \
       --end-date=2010/09/09 \
       --name=*yahoo*
date|name|address|source
2010-02-21|com.yahoo.ns5|119.160.247.124|A
2010-02-21|com.yahoo.ns1|68.180.131.16|A
2010-02-21|com.yahoo.ns3|121.101.152.99|A
2010-02-21|com.yahoo.ns2|68.142.255.16|A
2010-02-21|com.yahoo.ns4|68.142.196.63|A
</pre><p>To view all A records on a particular day: </p><pre class="fragment">$ orlookup --config-file=/etc/orcus.conf \
           --start-date=2010/02/21 \
       --source=A
</pre><p>To retrieve all results from 2010 that match a particular IP address: </p><pre class="fragment">$ orlookup --config-file=/etc/orcus.conf \
           --start-date=2010/01/01 \
       --end-date=2010/12/31 \
       --address=1.2.3.4
</pre><h1><a class="anchor" id="sm"></a>
Using super_mediator </h1>
<p><b>super_mediator</b> can be used to with <b>yaf</b> and <b>Orcus</b> to simply split the IPFIX input stream coming from <b>yaf</b> to <b>Orcus</b> and <b>SiLK</b> or it can be configured to perform deduplication of DNS resource records to reduce the data sent to and stored by Orcus. This tutorial will provide an example of a <b>super_mediator</b> configuration for both use cases.</p>
<h2>Using super_mediator to split the records to Orcus and SiLK </h2>
<p>The following configuration file for <b>super_mediator</b> listens on port 18000 for IPFIX data from <b>yaf</b>, writes the DNS data to the <b>Orcus</b> incoming directory and the flow data to <b>SiLK</b>. <b>super_mediator</b> is able to write to the incoming file directory for <b>Orcus</b> as it uses a lock method that will prevent <b>Orcus</b> from stealing the files before they are closed. The <b>LOCK</b> keyword is necessary in the <b>Orcus</b> exporter block (1st EXPORTER block). The second EXPORTER block is the <b>SiLK</b> exporter. The STATS_ONLY keyword is optional. If present, <b>super_mediator</b> will forward the <b>yaf</b> process statistics records to <b>SiLK</b> so they can be logged in the <b>rwflowpack</b> or <b>flowcap</b> log. </p><pre class="fragment">COLLECTOR TCP
   PORT 18000
COLLECTOR END

EXPORTER FILEHANDLER
  PATH "/tmp/orcus/incoming/sm_dns"
  APPLICATION == 53
  ROTATE 600
  DPI_ONLY
  LOCK
EXPORTER END

EXPORTER TCP
   PORT 18001
   FLOW_ONLY
   STATS_ONLY
EXPORTER END
</pre><p>The following options should be used when running <b>yaf</b>: </p><pre class="fragment">$ yaf --in eth0 --live pcap \
      --out localhost --ipfix tcp --ipfix-port=18000 \
  --applabel --max-payload=1024 \
  --plugin-name=/usr/local/lib/yaf/dpacketplugin.la \
  --plugin-opts=53 \
  --silk \
  --udp-uniflow=53 -v \
  -d ---log=/var/log/yaf.log
</pre><p>The SiLK <code>sensor.conf</code> should contain a probe similar to: </p><pre class="fragment">probe S1 ipfix
      protocol tcp
      listen-on-port 18001
end probe
</pre><p>For more information on configuring and installing SiLK, see <a href="yaf_silk.html">this tutorial</a></p>
<h2>super_mediator DNS deduplication </h2>
<p>The following <b>super_mediator</b> configuration file will enable deduplication of DNS resource records and the records will be written to rolling IPFIX files in the <b>Orcus</b> incoming directory. <b>SiLK</b> export is not configured, but could simply be added by using the above EXPORTER block in the following configuration.</p>
<pre class="fragment">COLLECTOR TCP
   PORT 18000
COLLECTOR END

EXPORTER FILEHANDLER
  PATH "/tmp/orcus/incoming/sm_dns"
  ROTATE 600
  DNS_DEDUP_ONLY
  LOCK
EXPORTER END

DNS_DEDUP
   MAX_HIT_COUNT 5000
   LAST_SEEN
DNS_DEDUP END
</pre><p><b>Note that the use of LAST_SEEN in the DNS_DEDUP block is required for Orcus to ingest the data.</b></p>
<p>Once again, using the <b>LOCK</b> keyword is required if <b>super_mediator</b> is writing to the <b>Orcus</b> incoming directory. The above <b>yaf</b> invocation can also be used for this configuration. If <b>super_mediator</b> is only exporting to <b>Orcus</b>, you may consider adding <code>--filter="port 53"</code> to the <b>yaf</b> invocation to filter out all non-DNS data.</p>
<p><b>super_mediator</b> deduplication is configurable. By default, <b>super_mediator</b> will export a deduplicated resource record every 5 minutes or when the hit count reaches 500. These settings can be modified by using the MAX_HIT_COUNT and FLUSH_TIME keywords in the DNS_DEDUP block. See the <a href="super_mediator.conf.html">super_mediator.conf</a> man page for more information.</p>
<p><em>Note: By using <b>super_mediator</b> to remove the duplicate records, the IP address (<b>address</b> field in <b>orquery</b>) that sent or received the query or response will be lost.</em> </p>
</div></div><!-- contents -->
      </div><!-- l-content -->
      <div id="l-footer">&copy; 2006-2016 Carnegie Mellon University</div>
    </div><!-- p-body -->
</body>
</html>   
