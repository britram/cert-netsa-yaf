<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
"http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<title>YAF - Documentation</title>
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
        <link rel="stylesheet" type="text/css" href="doxygen.css">
        <link rel="stylesheet" type="text/css" href="../../site/style.css" />
        <link rel="stylesheet" type="text/css" href="tabs.css">
</head>
<body>
    <div id="p-body">
      <div id="l-header">
        <img src="../../site/sei-logo.png" id="l-sei-logo"
            alt="Software Engineering Institute | Carnegie Mellon&copy;" />
        <div id="l-netsa-logo"><a id="l-netsa-name" href="../../index.html"><b>CERT NetSA Security Suite</b></a></div>
        <div id="l-netsa-motto">Monitoring for Large-Scale Networks</div>
        <h1 class="l-page-title">YAF</h1>
        <span id="l-subtitle">Documentation</span>
      </div><!-- l-header -->
      <div id="l-content">
        <div id="l-sidebar">
          <div class="p-sidebar-section">
            <h1><a href="index.html">YAF</a></h1>
            <ul>
              <li><a href="../docs.html">Documentation</a></li>
              <li><a href="../download.html">Downloads</a></li>
            </ul>
          </div><!-- p-sidebar-section -->
        </div><!-- l-sidebar -->
      <div id="top"> <!-- need this for doxygen -->
<!-- Generated by Doxygen 1.8.11 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Tutorials</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">Configuring YAF with super_mediator and SiLK </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>This tutorial is a step-by-step guide of setting up <b>yaf</b>, <a href="http://tools.netsa.cert.org/super_mediator/index.html">super_mediator</a>, and <a href="http://tools.netsa.cert.org/silk/index.html">SiLK</a>.</p>
<ul>
<li><a href="#overview">Overview</a></li>
<li><a href="#install">Basic Install</a><ul>
<li><a href="#mysql">Setup MySQL Database</a></li>
</ul>
</li>
<li><a href="#silk">Configure SiLK</a></li>
<li><a href="#sm">Configure super_mediator</a></li>
<li><a href="#goyaf">Run YAF</a></li>
<li><a href="#analysis">Analysis with MySQL/SiLK</a></li>
</ul>
<h1><a class="anchor" id="overview"></a>
Overview </h1>
<p>Check out this <a href="../../super_mediator/sm_guide.html">tutorial</a> for information on what super_mediator is and what data it can produce. This particular tutorial shows how super_mediator can insert the DPI data produced by <b>yaf</b> into a MySQL database. super_mediator will perform DNS deduplication on DNS resource records. This tutorial also shows how to do a basic install of SiLK and have <b>super_mediator</b> forward all the flows it receives to SiLK.</p>
<h1><a class="anchor" id="install"></a>
Install prerequisites </h1>
<p>$ yum groupinstall "Development Tools" $ yum install libpcap-devel pcre-devel mysql-server mysql-devel</p>
<p>Build <a href="http://tools.netsa.cert.org/fixbuf/index.html">libfixbuf</a>: </p><pre class="fragment">$ tar -xvzf libfixbuf-1.7.0.tar.gz
$ cd libfixbuf-1.7.0
$ ./configure
$ make
$ make install
</pre><p>Build <b>yaf</b>: </p><pre class="fragment">$ tar -xvzf yaf-2.8.0.tar.gz
$ cd yaf-2.8.0
$ ./configure --enable-applabel --enable-plugins
$ make
$ make install
</pre><p>Build <b>super_mediator</b>: </p><pre class="fragment">$ tar -xvzf super_mediator-1.2.0.tar.gz
$ cd super_mediator-1.2.0
$ ./configure --with-mysql
$ make
$ make install
</pre><p>Build <a href="http://tools.netsa.cert.org/silk/index.html">SiLK</a>: </p><pre class="fragment">$ tar -xvzf silk-3.11.0.tar.gz
$ cd silk-3.11.0
$ ./configure --with-libfixbuf=/usr/local/lib/pkgconfig --enable-ipv6
$ make
$ make install
</pre><h2><a class="anchor" id="mysql"></a>
Setup the MySQL Database  </h2>
<p>Setup mysqld </p><pre class="fragment">$ service mysqld start
</pre><p>Setup a password for the root user </p><pre class="fragment">$ /usr/bin/mysqladmin -u root password '&lt;SuperSecretPassword&gt;'
</pre><p>Login to the database (It will prompt you for the password you created in the last step): </p><pre class="fragment">$ mysql -u root -p
</pre><p>Create the database you intend to use for super_mediator: </p><pre class="fragment">mysql&gt; create database smediator;
</pre><p>Create a user for super_mediator to access the database: </p><pre class="fragment">mysql&gt; CREATE USER 'mediator'@'localhost' IDENTIFIED BY '&lt;SuperSecretPassword&gt;';
</pre><p>Giver permissions to user to access only the smediator database: </p><pre class="fragment">mysql&gt; GRANT ALL ON smediator.* TO mediator@'localhost';
</pre><h1><a class="anchor" id="silk"></a>
Setup SiLK </h1>
<p>We will using /data as the location of our SiLK repository: </p><pre class="fragment">$ mkdir -p /data
</pre><p>We will be using the default silk.conf file so copy it to the repo now: </p><pre class="fragment">$ cp site/twoway/silk.conf /data
$ cp src/rwflowpack/rwflowpack.conf /usr/local/etc/rwflowpack.conf
$ cp src/rwflowpack/rwflowpack.init.d /etc/init.d/rwflowpack
$ chmod +x /etc/init.d/rwflowpack
</pre><p>To configure <b>rwflowpack</b>, edit <code>/usr/local/etc/rwflowpack.conf</code> </p><pre class="fragment">#/usr/local/etc/rwflowpack.conf
ENABLED=1
statedirectory=/var/lib/rwflowpack
CREATE_DIRECTORIES=yes
BIN_DIR=/usr/local/sbin
SENSOR_CONFIG=/data/sensor.conf
DATA_ROOTDIR=/data
SITE_CONFIG=/data/silk.conf
PACKING_LOGIC=
INPUT_MODE=stream
INCOMING_DIR=${statedirectory}/incoming
ARCHIVE_DIR=${statedirectory}/archive
FLAT_ARCHIVE=0
ERROR_DIR=  #${statedirectory}/error
OUTPUT_MODE=local
SENDER_DIR=${statedirectory}/sender-incoming
INCREMENTAL_DIR=${statedirectory}/incremental
COMPRESSION_TYPE=
POLLING_INTERVAL=
FLUSH_TIMEOUT=
FILE_CACHE_SIZE=
FILE_LOCKING=1
PACK_INTERFACES=0
LOG_TYPE=syslog
LOG_LEVEL=info
LOG_DIR=${statedirectory}/log
PID_DIR=${LOG_DIR}
USER=root
EXTRA_OPTIONS=
</pre><p>We will need to create the Sensor configuration file <a href="http://tools.netsa.cert.org/silk/sensor.conf.html">sensor.conf</a> to setup the listening probe. Change the internal-ipblocks to match your network </p><pre class="fragment">probe S0 ipfix
   listen-on-port 18001
   protocol tcp
end probe

sensor S0
   ipfix-probes S0
   internal-ipblocks 192.168.1.0/24 10.10.10.0/24
   external-ipblocks remainder
end sensor
</pre><p>Move the sensor.conf to the repository: </p><pre class="fragment">$ mv sensor.conf /data
</pre><p>Start <b>rwflowpack</b>: </p><pre class="fragment">$ service rwflowpack start
</pre><p>Verify that rwflowpack is listening on port 18001: </p><pre class="fragment">$ netstat -vnatpl
</pre><p>To use the SiLK command line tools, you need to set the <b>SILK_DATA_ROOTDIR</b> variable: </p><pre class="fragment">$ export SILK_DATA_ROOTDIR=/data
</pre><h1><a class="anchor" id="sm"></a>
Using super_mediator </h1>
<p>Create the file directories that <b>super_mediator</b> will use to write files that will eventually get imported into the MySQL Database. </p><pre class="fragment">$ mkdir -p /data/smediator/dpi
$ mkdir -p /data/smediator/dns
</pre><p>Use <b>super_table_creator</b> to create all the tables in your database: </p><pre class="fragment">$ /usr/local/bin/super_table_creator --name mediator \
    --pass=&lt;SuperSecretPassword&gt; --database=smediator
$ /usr/local/bin/super_table_creator --name mediator \
    --pass=&lt;SuperSecretPassword&gt; \
--database=smediator --dns-dedup
</pre><p>Create your super_mediator.conf file. One is installed by default into /usr/local/etc. The following one will get you started: </p><pre class="fragment">COLLECTOR TCP
   PORT 18000
COLLECTOR END

#rwflowpack
EXPORTER TCP
   PORT 18001
   HOST localhost
   FLOW_ONLY
EXPORTER END

#dedup process

EXPORTER TEXT
   PATH "/data/smediator/dns/yaf2dns"
   DELIMITER "|"
   ROTATE 1200
   DNS_DEDUP_ONLY
   LOCK
   MYSQL_USER "mediator"
   MYSQL_PASSWORD "&lt;SuperSecretPassword&gt;"
   MYSQL_TABLE "dns-dedup"
   MYSQL_DATABASE "smediator"
EXPORTER END

#dpi 2 database
EXPORTER TEXT
   PATH "/data/smediator/dpi"
   ROTATE 1200
   MULTI_FILES
   DPI_ONLY
   LOCK
   MYSQL_USER "mediator"
   MYSQL_PASSWORD "&lt;SuperSecretPassword&gt;"
   MYSQL_DATABASE "smediator"
EXPORTER END

DNS_DEDUP
   MAX_HIT_COUNT 5000
DNS_DEDUP END

LOGLEVEL DEBUG

LOG "/var/log/super_mediator.log"

PIDFILE "/data/super_mediator.pid"
</pre><p>Start <b>super_mediator</b>: </p><pre class="fragment">$ super_mediator -c /usr/local/etc/super_mediator.conf --daemonize
</pre><p>Confirm <b>super_mediator</b> is running: </p><pre class="fragment">$ ps -ef | grep super
</pre><p>If <b>super_mediator</b> is not running, check for any errors: </p><pre class="fragment">$ cat /var/log/super_mediator.log
</pre><h1><a class="anchor" id="goyaf"></a>
Start YAF </h1>
<pre class="fragment">$ mkdir /var/log/yaf

$ export LTDL_LIBRARY_PATH=/usr/local/lib/yaf
</pre><p>Example <b>yaf</b> command line for processing a PCAP file: </p><pre class="fragment">/usr/local/bin/yaf
--in &lt;PCAP FILE&gt; \
--ipfix tcp \
--out localhost \
--log /var/log/yaf/yaf.log \
--verbose \
--silk \
--verbose \
--ipfix-port=18000 \
--applabel --max-payload 2048 \
--plugin-name=/usr/local/lib/yaf/dpacketplugin.so
</pre><p>Example <b>yaf</b> command line for sniffing interface eth0: </p><pre class="fragment">/usr/local/bin/yaf
--in eth0 --live pcap \
--ipfix tcp \
--out localhost \
--log /var/log/yaf/yaf.log \
--verbose \
--silk \
--verbose \
--ipfix-port=18000 \
--applabel --max-payload 2048 \
--plugin-name=/usr/local/lib/yaf/dpacketplugin.so
</pre><h1><a class="anchor" id="analysis"></a>
DNS Baselining with Pipeline </h1>
<p>Confirm MySQL database contains data: </p><pre class="fragment">$ mysql -u root -p

mysql&gt; use smediator;

mysql&gt; select table_name, table_rows from information_schema.tables where table_schema = DATABASE();
+-------------+------------+
| table_name  | table_rows |
+-------------+------------+
| dhcp        |          0 |
| dns         |      73414 |
| flow        |      39946 |
| ftp         |         36 |
| http        |      77462 |
| imap        |         78 |
| irc         |        224 |
| mysql       |          0 |
| nntp        |          0 |
| p0f         |          0 |
| pop3        |         12 |
| rtsp        |          0 |
| sip         |          0 |
| slp         |          0 |
| smtp        |         96 |
| ssh         |         44 |
| tftp        |          0 |
| tls         |      34370 |
+-------------+------------+
</pre><p>Confirm SiLK is creating flow records: </p><pre class="fragment">$ rwfilter --proto=0- --type=all --pass=stdout | rwcut | head</pre> </div></div><!-- contents -->
      </div><!-- l-content -->
      <div id="l-footer">&copy; 2006-2016 Carnegie Mellon University</div>
    </div><!-- p-body -->
</body>
</html>   
